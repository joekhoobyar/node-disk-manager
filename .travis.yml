dist: xenial
language: go

go:
  - 1.12.7

env:
  global:
   - ARCH=$(go env GOARCH)
   - TAG="ci"
   - CODECOV_TOKEN="d1e39bea-f800-45de-8266-3e9b85e2594a"

sudo: required

services:
  - docker

jobs:
  include:
    - name: amd64
      os: linux
      arch: amd64
    - name: arm64
      os: linux
      arch: arm64
    - name: ppc64le
      os: linux
      arch: ppc64le
    - name: arm32
      os: linux
      arch: amd64 # only as an emulation / cross-compile host
      env: ARCH=arm GOARCH=arm XC_ARCH=arm

addons:
  apt:
    update: true

install:
  - if [ "$ARCH" == "arm" ]; then
      docker run --rm --privileged multiarch/qemu-user-static --reset -p yes;
    fi
  - make bootstrap
  - if [ "$TRAVIS_BUILD_DIR" != "$GOPATH/src/github.com/openebs/node-disk-manager" ]; then
      mkdir -p $GOPATH/src/github.com/openebs/;
      mv $TRAVIS_BUILD_DIR $GOPATH/src/github.com/openebs;
      cd $GOPATH/src/github.com/openebs/node-disk-manager;
    fi
  - make install-dep
  - make install-test-infra

before_script:
  - if [ "$TRAVIS_CPU_ARCH" == "amd64" ] && [ "$ARCH" != "arm" ]; then
      sudo minikube start --vm-driver=none;
      sudo minikube update-context;
      sudo chown -R $USER $HOME/.minikube;
      sudo chown -R $USER $HOME/.kube;
      make shellcheck;
    fi

script:
  - make
  # Here sudo -E env "PATH=$PATH" make test is required for running tests with
  # sudo permissions since we are making use of scsi device mockdata in smartprobe_test
  # which could be fetched for a SCSI device with sudo permissions only since to access
  # a particular scsi device, sudo or root permissions are required.
  - sudo -E env "PATH=$PATH" make test
  - make integration-test

after_success:
  - make push
  - bash <(curl -s https://codecov.io/bash)
